<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>3D „Çπ„Éà„É™„É≥„Ç∞„Ç¢„Éº„ÉàÔºàÊ≠£ N/MËßíÂΩ¢Ôºâ</title>

  <style>
    :root{
      --bg:#0b0f17;
      --bgImg: radial-gradient(1200px 700px at 30% 20%, rgba(17,24,39,1), rgba(5,7,11,1));
      --fg:#e5e7eb;
      --muted:#9ca3af;

      --panel: rgba(17,24,39,.86);
      --panelSolid:#111827;

      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);

      --btnBg: rgba(255,255,255,.06);
      --btnBgHover: rgba(255,255,255,.10);
      --btnBorder: rgba(255,255,255,.14);

      --controlsBg: linear-gradient(to bottom, var(--panelSolid), rgba(17,24,39,.60));
      --boxBg: rgba(0,0,0,.18);
      --cardBg: rgba(255,255,255,.04);

      --inputBg: rgba(0,0,0,.25);

      --overlayBg: rgba(0,0,0,.55);
      --modalBg: rgba(17,24,39,.96);
      --modalBorder: rgba(255,255,255,.10);
      --modalBodyBg: rgba(0,0,0,.18);
      --modalRowBg: rgba(255,255,255,.03);
      --modalRowBorder: rgba(255,255,255,.08);
      --shadow: 0 20px 60px rgba(0,0,0,.45);

      --hudBg: rgba(0,0,0,.55);
      --hudFg: rgba(255,255,255,.92);
      --hudBorder: rgba(255,255,255,.18);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      background-color: var(--bg);
      background-image: var(--bgImg);
      color:var(--fg);
      overflow:hidden;
    }

    .wrap{
      display:grid;
      grid-template-columns: 440px 1fr;
      height:100vh;
      width:100vw;
    }

    .panel{
      height:100vh;
      overflow-y:auto;
      padding:16px;
      background: var(--panel);
      border-right: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }

    h1{ font-size:18px; margin:0 0 10px; }

    .controlsTop{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center;
      position: sticky; top: 0; z-index: 5;
      padding: 10px 0;
      background: var(--controlsBg);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--btnBorder);
      background: var(--btnBg);
      color:var(--fg);
      cursor:pointer;
      user-select:none;
    }
    button:hover{ background: var(--btnBgHover); }

    .btnPrimary{ border-color: rgba(96,165,250,.55); }
    .btnToggle { border-color: rgba(52,211,153,.45); }
    .btnWarn   { border-color: rgba(251,191,36,.55); }

    .rows{
      display:flex; flex-direction:column; gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background: var(--boxBg);
      margin-bottom: 12px;
    }

    .rowCard{
      display:grid;
      grid-template-columns: 1fr 1fr auto auto auto;
      gap:8px;
      align-items:center;
      padding:10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: var(--cardBg);
    }
    .rowCard .label{
      font-size:11px; color:var(--muted); margin-bottom:4px;
    }
    .rowCard .field{ display:flex; flex-direction:column; }

    input[type="number"]{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: var(--inputBg);
      color:var(--fg);
      outline:none;
    }

    .iconBtn{
      width:40px; height:40px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-size:16px;
      color: var(--fg);
    }
    .iconBtn:hover{ background: rgba(255,255,255,.10); }

    .swatch{
      width:14px; height:14px; border-radius:6px;
      border:1px solid rgba(255,255,255,.25);
      display:inline-block;
      vertical-align:middle;
      margin-left:6px;
    }
    .rowMeta{
      grid-column: 1 / -1;
      font-size:11px;
      color: var(--muted);
      margin-top:4px;
      line-height:1.55;
    }

    .globalBox{
      margin-top:12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: var(--boxBg);
      font-size:12px;
      line-height:1.65;
      color: var(--muted);
    }
    .globalBox b{ color:var(--fg); }

    .viewer{
      position:relative;
      height:100vh;
      width:100%;
    }
    canvas#stage{
      width:100%;
      height:100%;
      display:block;
      cursor: grab;
      touch-action:none;
      user-select:none;
    }
    canvas#stage.dragging{ cursor: grabbing; }

    /* HUD: Á∑ö„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å†„ÅëË°®Á§∫ */
    .hud{
      position:absolute;
      left:12px; top:12px;
      background: var(--hudBg);
      border:1px solid var(--hudBorder);
      color: var(--hudFg);
      padding:12px 16px;
      border-radius:14px;
      font-size:20px;     /* Â∞ë„ÅóÂ§ß„Åç„ÇÅ */
      font-weight:600;
      letter-spacing:0.03em;
      pointer-events:none;
      white-space:nowrap;
      max-width: 70vw;
      overflow:hidden;
      text-overflow: ellipsis;
      display:none;
    }
    .hud .nmBadge{
      padding:6px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      display:inline-block;
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: var(--overlayBg);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 1000;
    }
    .modal{
      width:min(580px, 96vw);
      background: var(--modalBg);
      border:1px solid var(--modalBorder);
      border-radius:18px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .modalTitle{ font-size:14px; font-weight:700; }
    .closeBtn{
      width:38px; height:38px; border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color:var(--fg); cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
    }
    .closeBtn:hover{ background: rgba(255,255,255,.10); }

    .modalBody{
      display:flex; flex-direction:column; gap:10px;
      padding:10px;
      border:1px solid var(--modalRowBorder);
      border-radius:14px;
      background: var(--modalBodyBg);
      font-size:12px;
    }
    .modalRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 8px;
      border-radius:12px;
      border:1px solid var(--modalRowBorder);
      background: var(--modalRowBg);
    }
    .modalRow .left{ color: var(--fg); }
    .modalRow .right{ display:flex; gap:8px; align-items:center; }

    input[type="color"]{
      width:44px; height:32px;
      border:none; background: transparent; padding:0;
      cursor:pointer;
    }
    .miniInput{
      width: 170px;
      padding:8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: var(--inputBg);
      color: var(--fg);
      outline:none;
      font-size: 12px;
    }
    select.miniInput{ width: 190px; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <h1>3D „Çπ„Éà„É™„É≥„Ç∞„Ç¢„Éº„ÉàÔºàÊ≠£ N/MÔºâ</h1>

    <div class="controlsTop">
      <button id="addRow" class="btnPrimary">Ôºã ËøΩÂä†</button>
      <button id="resetAll" class="btnWarn">„É™„Çª„ÉÉ„Éà</button>
      <button id="toggleAll" class="btnToggle">‚ñ∂ ÂÖ®„Ç¢„Éã„É°ÂÜçÁîü</button>
      <button id="openGlobal" class="btnWarn">Ë®≠ÂÆö</button>
      <button id="saveAll">PNG‰øùÂ≠ò</button>
    </div>

    <div class="rows" id="rows"></div>
    <div class="globalBox" id="globalInfo"></div>
  </div>

  <div class="viewer">
    <canvas id="stage"></canvas>
    <div class="hud" id="hud"><span class="nmBadge" id="hudNM"></span></div>
  </div>
</div>

<!-- Ë°åË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
<div class="modalOverlay" id="rowModalOverlay">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div class="modalTitle" id="rowModalTitle">Ë®≠ÂÆö</div>
      <button class="closeBtn" id="rowModalClose" title="Èñâ„Åò„Çã">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="modalRow">
        <div class="left">„Åì„ÅÆÂõ≥ÂΩ¢„ÇíË°®Á§∫</div>
        <div class="right"><input type="checkbox" id="optVisible"></div>
      </div>

      <div class="modalRow">
        <div class="left">È†ÇÁÇπ„ÇíË°®Á§∫</div>
        <div class="right"><input type="checkbox" id="optShowPoints"></div>
      </div>

      <div class="modalRow">
        <div class="left">È†ÇÁÇπÁï™Âè∑„ÇíË°®Á§∫</div>
        <div class="right"><input type="checkbox" id="optShowLabels"></div>
      </div>

      <div class="modalRow">
        <div class="left">È†ÇÁÇπÁï™Âè∑„Çµ„Ç§„Ç∫ÔºàpxÔºâ</div>
        <div class="right">
          <input class="miniInput" type="number" id="optLabelSize" min="8" step="1" />
        </div>
      </div>

      <div class="modalRow">
        <div class="left">Á∑ö„ÅÆËâ≤</div>
        <div class="right"><input type="color" id="optLineColor"></div>
      </div>

      <div class="modalRow">
        <div class="left">È†ÇÁÇπ„ÅÆËâ≤</div>
        <div class="right"><input type="color" id="optPointColor"></div>
      </div>

      <div class="modalRow">
        <div class="left">„Ç¢„Éã„É°ÊôÇÈñìÔºàÁßíÔºâ</div>
        <div class="right">
          <input class="miniInput" type="number" id="optAnimTime" min="0.2" step="0.1" />
        </div>
      </div>

      <div class="modalRow">
        <div class="left">ÂßãÁÇπÔºàstartÔºâ</div>
        <div class="right">
          <input class="miniInput" type="number" id="optStart" step="1" />
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ÂÖ®‰ΩìË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
<div class="modalOverlay" id="globalModalOverlay">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div class="modalTitle">ÂÖ®‰ΩìË®≠ÂÆö</div>
      <button class="closeBtn" id="globalModalClose" title="Èñâ„Åò„Çã">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="modalRow">
        <div class="left">ËÉåÊôØ</div>
        <div class="right">
          <select id="optTheme" class="miniInput">
            <option value="dark">„ÉÄ„Éº„ÇØ</option>
            <option value="light">„É©„Ç§„Éà</option>
          </select>
        </div>
      </div>

      <div class="modalRow">
        <div class="left">ÂÜÜ„Ç¨„Ç§„Éâ„ÅÆËâ≤</div>
        <div class="right">
          <input type="color" id="optCircleColor">
        </div>
      </div>

      <div class="modalRow">
        <div class="left">ÂçäÂæÑ R</div>
        <div class="right">
          <input class="miniInput" type="number" id="optRadius" min="0.1" step="0.1">
        </div>
      </div>

      <div class="modalRow">
        <div class="left">È´ò„Åï H</div>
        <div class="right">
          <input class="miniInput" type="number" id="optHeight" min="0.1" step="0.1">
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function loadScriptWithFallback(urls){
  return new Promise((resolve, reject) => {
    let i = 0;
    const tryNext = () => {
      if (i >= urls.length) { reject(new Error("All script sources failed: " + urls.join(" | "))); return; }
      const url = urls[i++];
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      s.onload = () => resolve(url);
      s.onerror = () => { s.remove(); tryNext(); };
      document.head.appendChild(s);
    };
    tryNext();
  });
}

window.addEventListener("load", async () => {
  try{
    const threeUrl = await loadScriptWithFallback([
      "./three.min.js",
      "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js",
      "https://unpkg.com/three@0.160.0/build/three.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js",
      "https://threejs.org/build/three.min.js"
    ]);

    if (typeof THREE === "undefined") throw new Error("THREE is undefined after loading script: " + threeUrl);
    new StringArt3DApp({ threeUrl }).boot();
  }catch(e){
    console.error(e);
    alert("Ëµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
  }
});

class MathUtil{
  static TAU = Math.PI * 2;
  static mod(n, m){ return ((n % m) + m) % m; }
  static gcd(a,b){
    a = Math.abs(a); b = Math.abs(b);
    while(b!==0){ const t=a%b; a=b; b=t; }
    return a;
  }
}

class CycleBuilder{
  static buildCycle3D(N, M, start){
    const step = MathUtil.mod(M, N);
    const s = MathUtil.mod(start, N);
    const nodes = [{ side:"T", idx:s }];

    if (N <= 0 || step === 0){
      nodes.push({ side:"T", idx:s });
      return { valid:true, nodes, step, edges: Math.max(0, nodes.length-1) };
    }

    let curSide = "T";
    let curIdx = s;

    const seen = new Set([`T:${s}`]);
    const maxSteps = 2*N + 10;

    for (let t=0; t<maxSteps; t++){
      const nextSide = (curSide === "T") ? "B" : "T";
      const nextIdx = MathUtil.mod(curIdx + step, N);
      nodes.push({ side: nextSide, idx: nextIdx });

      if (nextSide === "T" && nextIdx === s){
        return { valid:true, nodes, step, edges: Math.max(0, nodes.length-1) };
      }

      const key = `${nextSide}:${nextIdx}`;
      if (seen.has(key)) break;
      seen.add(key);

      curSide = nextSide;
      curIdx = nextIdx;
    }

    return { valid:false, nodes, step, edges: Math.max(0, nodes.length-1) };
  }
}

class ThemeManager{
  constructor(){
    this.state = { theme: 'dark', circleHex: '#b0b0b0' };
  }
  applyTheme(){
    const root = document.documentElement.style;
    if (this.state.theme === 'light'){
      root.setProperty('--bg', '#ffffff');
      root.setProperty('--bgImg', 'none');
      root.setProperty('--fg', '#111827');
      root.setProperty('--muted', '#374151');

      root.setProperty('--panel', '#ffffff');
      root.setProperty('--panelSolid', '#ffffff');

      root.setProperty('--border', 'rgba(0,0,0,.12)');
      root.setProperty('--border2', 'rgba(0,0,0,.16)');

      root.setProperty('--btnBg', '#ffffff');
      root.setProperty('--btnBgHover', 'rgba(0,0,0,.06)');
      root.setProperty('--btnBorder', 'rgba(0,0,0,.30)');

      root.setProperty('--controlsBg', 'linear-gradient(to bottom, rgba(255,255,255,1), rgba(255,255,255,.65))');
      root.setProperty('--boxBg', 'rgba(0,0,0,.03)');
      root.setProperty('--cardBg', 'rgba(0,0,0,.02)');

      root.setProperty('--overlayBg', 'rgba(0,0,0,.25)');
      root.setProperty('--modalBg', '#ffffff');
      root.setProperty('--modalBorder', 'rgba(0,0,0,.18)');
      root.setProperty('--modalBodyBg', '#ffffff');
      root.setProperty('--modalRowBg', '#ffffff');
      root.setProperty('--modalRowBorder', 'rgba(0,0,0,.12)');
      root.setProperty('--inputBg', '#ffffff');
      root.setProperty('--shadow', '0 20px 60px rgba(0,0,0,.18)');

      root.setProperty('--hudBg', 'rgba(255,255,255,.92)');
      root.setProperty('--hudFg', 'rgba(17,24,39,.98)');
      root.setProperty('--hudBorder', 'rgba(0,0,0,.20)');
    } else {
      root.setProperty('--bg', '#0b0f17');
      root.setProperty('--bgImg', 'radial-gradient(1200px 700px at 30% 20%, rgba(17,24,39,1), rgba(5,7,11,1))');
      root.setProperty('--fg', '#e5e7eb');
      root.setProperty('--muted', '#9ca3af');

      root.setProperty('--panel', 'rgba(17,24,39,.86)');
      root.setProperty('--panelSolid', '#111827');

      root.setProperty('--border', 'rgba(255,255,255,.10)');
      root.setProperty('--border2', 'rgba(255,255,255,.14)');

      root.setProperty('--btnBg', 'rgba(255,255,255,.06)');
      root.setProperty('--btnBgHover', 'rgba(255,255,255,.10)');
      root.setProperty('--btnBorder', 'rgba(255,255,255,.14)');

      root.setProperty('--controlsBg', 'linear-gradient(to bottom, var(--panelSolid), rgba(17,24,39,.60))');
      root.setProperty('--boxBg', 'rgba(0,0,0,.18)');
      root.setProperty('--cardBg', 'rgba(255,255,255,.04)');

      root.setProperty('--overlayBg', 'rgba(0,0,0,.55)');
      root.setProperty('--modalBg', 'rgba(17,24,39,.96)');
      root.setProperty('--modalBorder', 'rgba(255,255,255,.10)');
      root.setProperty('--modalBodyBg', 'rgba(0,0,0,.18)');
      root.setProperty('--modalRowBg', 'rgba(255,255,255,.03)');
      root.setProperty('--modalRowBorder', 'rgba(255,255,255,.08)');
      root.setProperty('--inputBg', 'rgba(0,0,0,.25)');
      root.setProperty('--shadow', '0 20px 60px rgba(0,0,0,.45)');

      root.setProperty('--hudBg', 'rgba(0,0,0,.55)');
      root.setProperty('--hudFg', 'rgba(255,255,255,.92)');
      root.setProperty('--hudBorder', 'rgba(255,255,255,.18)');
    }
  }
  getLabelPalette(){
    if (this.state.theme === 'light'){
      return { fill: "rgba(17,24,39,0.96)", stroke: "rgba(255,255,255,0.92)" };
    }
    return { fill: "rgba(255,255,255,0.92)", stroke: "rgba(0,0,0,0.78)" };
  }
}

class RenderScheduler{
  constructor(renderFn){
    this.renderFn = renderFn;
    this.pending = false;
  }
  request(){
    if (this.pending) return;
    this.pending = true;
    requestAnimationFrame(()=>{
      this.pending = false;
      this.renderFn();
    });
  }
}

class ThreeScene{
  constructor({ stage, themeManager, requestRender }){
    this.stage = stage;
    this.themeManager = themeManager;
    this.requestRender = requestRender;

    this.renderer = new THREE.WebGLRenderer({
      canvas: stage,
      antialias: true,
      alpha: false,
      preserveDrawingBuffer: true,
    });
    this.renderer.setPixelRatio(Math.min(2.5, window.devicePixelRatio || 1));

    this.scene = new THREE.Scene();
    this.camera = new THREE.PerspectiveCamera(55, 1, 0.01, 500);

    this.scene.add(new THREE.AmbientLight(0xffffff, 0.60));
    const dir = new THREE.DirectionalLight(0xffffff, 0.90);
    dir.position.set(6, 10, 8);
    this.scene.add(dir);

    this.root3D = new THREE.Group();
    this.scene.add(this.root3D);

    this.guideGroup = new THREE.Group();
    this.root3D.add(this.guideGroup);

    this.raycaster = new THREE.Raycaster();
    this.raycaster.params.Line = { threshold: 0.12 };
    this.pointerNDC = new THREE.Vector2();

    this.view = {
      target: new THREE.Vector3(0,0,0),
      dist: 12,
      yaw: 0.9,
      pitch: 0.55,
      minDist: 2.0,
      maxDist: 120.0,
      minPitch: -1.45,
      maxPitch:  1.45
    };

    this._installCameraControls();
  }

  _installCameraControls(){
    const stage = this.stage;
    stage.addEventListener("contextmenu", (e)=>e.preventDefault());

    const updateCamera = () => {
      const v = this.view;
      const cp = Math.cos(v.pitch);
      const sp = Math.sin(v.pitch);
      const cy = Math.cos(v.yaw);
      const sy = Math.sin(v.yaw);

      const x = v.target.x + v.dist * cp * cy;
      const y = v.target.y + v.dist * sp;
      const z = v.target.z + v.dist * cp * sy;

      this.camera.position.set(x,y,z);
      this.camera.lookAt(v.target);
      this.camera.updateProjectionMatrix();
      this.requestRender();
    };
    this.updateCamera = updateCamera;

    const panScale = () => this.view.dist * 0.0012;

    let dragging = false;
    let dragButton = 0;
    let lastX = 0, lastY = 0;

    stage.addEventListener("pointerdown", (e)=>{
      dragging = true;
      dragButton = e.button;
      lastX = e.clientX;
      lastY = e.clientY;
      stage.classList.add("dragging");
      stage.setPointerCapture(e.pointerId);
    });

    stage.addEventListener("pointerup", (e)=>{
      dragging = false;
      stage.classList.remove("dragging");
      try{ stage.releasePointerCapture(e.pointerId); }catch(_){}
    });

    stage.addEventListener("pointermove", (e)=>{
      if (!dragging) return;
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      lastX = e.clientX;
      lastY = e.clientY;

      if (dragButton === 2) {
        const s = panScale();
        const forward = new THREE.Vector3().subVectors(this.view.target, this.camera.position).normalize();
        const right = new THREE.Vector3().crossVectors(forward, this.camera.up).normalize();
        const up = new THREE.Vector3().crossVectors(right, forward).normalize();

        this.view.target.addScaledVector(right, -dx * s);
        this.view.target.addScaledVector(up,   dy * s);
        updateCamera();
      } else if (dragButton === 0) {
        this.view.yaw   -= dx * 0.006;
        this.view.pitch -= dy * 0.006;
        this.view.pitch = Math.max(this.view.minPitch, Math.min(this.view.maxPitch, this.view.pitch));
        updateCamera();
      }
    });

    stage.addEventListener("wheel", (e)=>{
      e.preventDefault();
      const factor = Math.exp(e.deltaY * 0.0012);
      this.view.dist *= factor;
      this.view.dist = Math.max(this.view.minDist, Math.min(this.view.maxDist, this.view.dist));
      updateCamera();
    }, { passive:false });

    updateCamera();
  }

  resize(){
    const w = this.stage.clientWidth;
    const h = this.stage.clientHeight;
    this.renderer.setSize(w, h, false);
    this.camera.aspect = w / h;
    this.camera.updateProjectionMatrix();
  }

  render(){
    this.renderer.render(this.scene, this.camera);
  }

  resetViewToFit(R,H){
    const bound = Math.sqrt(R*R + (H*0.5)*(H*0.5));
    this.view.dist = Math.max(3, bound * 3.0);
    this.view.target.set(0,0,0);
    this.view.yaw = 0.9;
    this.view.pitch = 0.55;
    this.updateCamera();
  }

  hexToThreeColor(hex){
    try{ return new THREE.Color(hex); }catch(_){ return new THREE.Color(0xffffff); }
  }

  rebuildGuides({ radius:R, height:H }){
    while (this.guideGroup.children.length){
      const obj = this.guideGroup.children.pop();
      obj.geometry?.dispose?.();
      obj.material?.dispose?.();
    }

    const seg = 180;
    const circleColor = this.hexToThreeColor(this.themeManager.state.circleHex);
    const isLight = (this.themeManager.state.theme === 'light');

    const mat = new THREE.LineBasicMaterial({
      color: circleColor,
      transparent: true,
      opacity: 0.55
    });

    const ring = (z) => {
      const pts = [];
      for (let k=0;k<=seg;k++){
        const a = MathUtil.TAU * (k/seg);
        pts.push(R*Math.cos(a), R*Math.sin(a), z);
      }
      const geo = new THREE.BufferGeometry();
      geo.setAttribute("position", new THREE.Float32BufferAttribute(pts, 3));
      return new THREE.Line(geo, mat.clone());
    };

    this.guideGroup.add(ring(+H/2));
    this.guideGroup.add(ring(-H/2));

    this.scene.background = new THREE.Color(isLight ? "#ffffff" : "#0b0f17");
    this.resetViewToFit(R, H);
  }

  pickLine(clientX, clientY, lineObjects){
    const rect = this.stage.getBoundingClientRect();
    const x = ((clientX - rect.left) / rect.width) * 2 - 1;
    const y = -(((clientY - rect.top) / rect.height) * 2 - 1);
    this.pointerNDC.set(x,y);
    this.raycaster.setFromCamera(this.pointerNDC, this.camera);
    const hits = this.raycaster.intersectObjects(lineObjects, false);
    if (!hits.length) return null;
    return hits[0].object;
  }
}

class RowModel{
  constructor(initial){
    Object.assign(this, initial);
    this.group = null;
    this.pathLine = null;
    this.pathBasePos = null;
    this.pathEdges = 0;
    this.animPlaying = false;
    this.animProgressEdges = 0.0;
    this.animSpeedEdgesPerSec = 0.0;
  }
}

class RowBuilder{
  constructor({ threeScene, themeManager, globalState }){
    this.three = threeScene;
    this.themeManager = themeManager;
    this.globalState = globalState;
  }

  disposeObject(obj){
    obj.traverse((x)=>{
      if (x.geometry) x.geometry.dispose();
      if (x.material){
        if (Array.isArray(x.material)) x.material.forEach(m=>m.dispose());
        else x.material.dispose();
      }
      if (x.userData?._labelTexture) x.userData._labelTexture.dispose?.();
    });
  }

  clearRow3D(r){
    if (!r.group) return;
    this.three.root3D.remove(r.group);
    this.disposeObject(r.group);
    r.group = null;
    r.pathLine = null;
    r.pathBasePos = null;
    r.pathEdges = 0;
  }

  makeLabelSprite(text, fontPx, fill, stroke){
    const size = 256;
    const canvas = document.createElement("canvas");
    canvas.width = size; canvas.height = size;
    const c = canvas.getContext("2d");

    c.clearRect(0,0,size,size);
    c.font = `800 ${fontPx}px system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif`;
    c.textAlign = "center";
    c.textBaseline = "middle";

    c.lineJoin = "round";
    c.lineWidth = Math.max(6, fontPx * 0.28);
    c.strokeStyle = stroke;
    c.strokeText(text, size/2, size/2);

    c.fillStyle = fill;
    c.fillText(text, size/2, size/2);

    const tex = new THREE.CanvasTexture(canvas);
    tex.anisotropy = 4;
    tex.needsUpdate = true;

    const mat = new THREE.SpriteMaterial({
      map: tex,
      transparent: true,
      depthWrite: false,
      depthTest: true
    });

    const spr = new THREE.Sprite(mat);
    spr.userData._labelTexture = tex;
    return spr;
  }

  setRowLineProgress(r, pEdges){
    if (!r.pathLine || !r.pathBasePos) return;
    const edges = r.pathEdges;
    const geo = r.pathLine.geometry;
    const posAttr = geo.getAttribute("position");
    const pos = posAttr.array;

    const t = Math.max(0, Math.min(edges, pEdges));
    const whole = Math.floor(t);
    const frac = t - whole;

    if (edges <= 0){
      geo.setDrawRange(0, 0);
      return;
    }

    if (whole < edges && frac > 0){
      const visibleVerts = whole + 2;
      geo.setDrawRange(0, visibleVerts);

      const aIdx = whole;
      const bIdx = whole + 1;

      const ax = r.pathBasePos[aIdx*3+0], ay = r.pathBasePos[aIdx*3+1], az = r.pathBasePos[aIdx*3+2];
      const bx = r.pathBasePos[bIdx*3+0], by = r.pathBasePos[bIdx*3+1], bz = r.pathBasePos[bIdx*3+2];

      pos[bIdx*3+0] = ax + (bx-ax)*frac;
      pos[bIdx*3+1] = ay + (by-ay)*frac;
      pos[bIdx*3+2] = az + (bz-az)*frac;

      posAttr.needsUpdate = true;
      return;
    }

    const visibleVerts = whole + 1;
    geo.setDrawRange(0, visibleVerts);

    if (visibleVerts >= 1){
      const last = visibleVerts - 1;
      pos[last*3+0] = r.pathBasePos[last*3+0];
      pos[last*3+1] = r.pathBasePos[last*3+1];
      pos[last*3+2] = r.pathBasePos[last*3+2];
      posAttr.needsUpdate = true;
    }
  }

  buildRow3D(r){
    this.clearRow3D(r);
    if (!r.visible) return;

    const N = r.N, M = r.M;
    if (!Number.isInteger(N) || !Number.isInteger(M) || N < 3 || M < 1) return;

    const R = this.globalState.radius;
    const H = this.globalState.height;

    const info = CycleBuilder.buildCycle3D(N, M, r.start);
    if (!info.valid || info.edges <= 0) return;

    const group = new THREE.Group();
    r.group = group;
    this.three.root3D.add(group);

    const zTop = +H/2, zBot = -H/2;

    if (r.showPoints){
      const g = new THREE.SphereGeometry(Math.max(0.03, R*0.02), 16, 16);
      const m = new THREE.MeshStandardMaterial({
        color: new THREE.Color(r.pointColor),
        roughness: 0.25,
        metalness: 0.05
      });

      for (let i=0;i<N;i++){
        const ang = MathUtil.TAU*(i/N) - Math.PI/2;
        const x = R*Math.cos(ang);
        const y = R*Math.sin(ang);

        const sTop = new THREE.Mesh(g, m);
        sTop.position.set(x,y,zTop);
        group.add(sTop);

        const sBot = new THREE.Mesh(g, m);
        sBot.position.set(x,y,zBot);
        group.add(sBot);
      }
    }

    if (r.showLabels){
      const { fill, stroke } = this.themeManager.getLabelPalette();
      const fontPx = Math.max(8, Math.floor(Number(r.labelSizePx) || 100));
      const worldSize = Math.max(0.16, R * 0.16);
      const off = Math.max(0.22, R * 0.12);

      for (let i=0;i<N;i++){
        const ang = MathUtil.TAU*(i/N) - Math.PI/2;
        const x = R*Math.cos(ang);
        const y = R*Math.sin(ang);
        const len = Math.hypot(x,y) || 1;
        const nx = x/len, ny=y/len;

        const sprT = this.makeLabelSprite(String(i), fontPx, fill, stroke);
        sprT.position.set(x + nx*off, y + ny*off, zTop);
        sprT.scale.set(worldSize, worldSize, 1);
        group.add(sprT);

        const sprB = this.makeLabelSprite(String(i), fontPx, fill, stroke);
        sprB.position.set(x + nx*off, y + ny*off, zBot);
        sprB.scale.set(worldSize, worldSize, 1);
        group.add(sprB);
      }
    }

    const pts = [];
    for (const nd of info.nodes){
      const ang = MathUtil.TAU*(nd.idx/N) - Math.PI/2;
      const x = R*Math.cos(ang);
      const y = R*Math.sin(ang);
      const z = (nd.side === "T") ? zTop : zBot;
      pts.push(x,y,z);
    }

    r.pathEdges = Math.max(0, pts.length/3 - 1);

    const arr = new Float32Array(pts);
    r.pathBasePos = new Float32Array(arr);

    const geo = new THREE.BufferGeometry();
    geo.setAttribute("position", new THREE.Float32BufferAttribute(arr, 3));
    geo.setDrawRange(0, 0);

    const mat = new THREE.LineBasicMaterial({
      color: new THREE.Color(r.lineColor),
      transparent:true,
      opacity:0.95
    });

    const line = new THREE.Line(geo, mat);
    line.userData.rowId = r.id;
    line.userData.baseColorHex = r.lineColor;   // ‚òÖ „Éè„Ç§„É©„Ç§„ÉàÂæ©Â∏∞Áî®
    r.pathLine = line;
    group.add(line);

    if (!r.animPlaying) this.setRowLineProgress(r, r.pathEdges);
    else this.setRowLineProgress(r, 0);
  }
}

class StringArt3DApp{
  constructor({ threeUrl }){
    this.stage = document.getElementById("stage");
    this.hud = document.getElementById("hud");
    this.hudNM = document.getElementById("hudNM");
    this.rowsEl = document.getElementById("rows");
    this.globalInfoEl = document.getElementById("globalInfo");

    this.btnAdd = document.getElementById("addRow");
    this.btnReset = document.getElementById("resetAll");
    this.btnToggleAll = document.getElementById("toggleAll");
    this.btnSave = document.getElementById("saveAll");
    this.btnOpenGlobal = document.getElementById("openGlobal");

    this.rowModalOverlay = document.getElementById('rowModalOverlay');
    this.rowModalTitle = document.getElementById('rowModalTitle');
    this.rowModalClose = document.getElementById('rowModalClose');
    this.optVisible = document.getElementById('optVisible');
    this.optShowPoints = document.getElementById('optShowPoints');
    this.optShowLabels = document.getElementById('optShowLabels');
    this.optLabelSize = document.getElementById('optLabelSize');
    this.optLineColor = document.getElementById('optLineColor');
    this.optPointColor = document.getElementById('optPointColor');
    this.optAnimTime = document.getElementById('optAnimTime');
    this.optStart = document.getElementById('optStart');

    this.globalModalOverlay = document.getElementById('globalModalOverlay');
    this.globalModalClose = document.getElementById('globalModalClose');
    this.optTheme = document.getElementById('optTheme');
    this.optCircleColor = document.getElementById('optCircleColor');
    this.optRadius = document.getElementById('optRadius');
    this.optHeight = document.getElementById('optHeight');

    this.threeUrl = threeUrl;
    this.themeManager = new ThemeManager();
    this.globalState = { radius: 3.0, height: 4.0 };

    this.scheduler = new RenderScheduler(()=>this._renderOnce());

    this.three = new ThreeScene({
      stage: this.stage,
      themeManager: this.themeManager,
      requestRender: ()=>this.requestRender()
    });

    this.rowBuilder = new RowBuilder({
      threeScene: this.three,
      themeManager: this.themeManager,
      globalState: this.globalState
    });

    this.DEFAULT_ANIM_TIME = 8.0;
    this.DEFAULT_START = 0;
    this.DEFAULT_LABEL_SIZE = 100;

    this.palette = [
      "#60a5fa", "#f472b6", "#34d399", "#f59e0b", "#a78bfa",
      "#22d3ee", "#fb7185", "#84cc16", "#e879f9", "#f87171",
    ];

    this.nextId = 1;
    this.rows = [];
    this.globalPlaying = false;

    this.rafAnim = null;
    this.lastT = null;

    this._downX = 0;
    this._downY = 0;

    this._pickedLine = null;
  }

  requestRender(){ this.scheduler.request(); }

  _renderOnce(){
    this.three.resize();
    this.three.render();
  }

  boot(){
    this.themeManager.applyTheme();
    this.three.rebuildGuides(this.globalState);

    this._installEvents();

    this.addRow({
      N:null, M:null,
      start:this.DEFAULT_START,
      animTimeSec:this.DEFAULT_ANIM_TIME,
      labelSizePx:this.DEFAULT_LABEL_SIZE
    });

    this.hidePickedNM();
    this.redrawAll();
  }

  redrawAll(){
    this.three.resize();
    for (const r of this.rows) this.rowBuilder.buildRow3D(r);
    this.updateGlobalInfo();
    this.requestRender();

    if (this.anyAnimationPlaying() && !this.rafAnim){
      this.rafAnim = requestAnimationFrame((t)=>this._tick(t));
    }
  }

  showPickedNM(rowId, N, M){
    this.hudNM.textContent = `#${rowId}  N = ${N},  M = ${M}`;
    this.hud.style.display = 'block';
  }

  hidePickedNM(){
    this.hudNM.textContent = '';
    this.hud.style.display = 'none';
  }

  // ‚òÖ „ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÁ∑ö„Çí‰∏ÄÁû¨„Éè„Ç§„É©„Ç§„Éà
  flashHighlightLine(line){
    if (!line || !line.material) return;

    // ÂâçÂõû„ÅÆ„Éè„Ç§„É©„Ç§„ÉàÂæ©Â∏∞„ÅåÊÆã„Å£„Å¶„ÅÑ„Åü„ÇâËß£Èô§
    if (line.userData._hlTimeout){
      clearTimeout(line.userData._hlTimeout);
      line.userData._hlTimeout = null;
    }

    // „ÇÇ„Å®„ÇÇ„Å®„ÅÆËâ≤„ÇíÁ¢∫ÂÆü„Å´‰øùÊåÅÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
    if (!line.userData._origColorHex){
      const c = line.material.color;
      line.userData._origColorHex = "#" + c.getHexString();
    }
    if (typeof line.material.opacity === "number" && line.userData._origOpacity == null){
      line.userData._origOpacity = line.material.opacity;
    }

    const highlightHex = (this.themeManager.state.theme === "light") ? "#111827" : "#fde047"; // ÁõÆÁ´ã„Å§Ëâ≤
    line.material.color.set(highlightHex);
    line.material.opacity = 1.0;
    line.material.needsUpdate = true;
    this.requestRender();

    line.userData._hlTimeout = setTimeout(()=>{
      const backHex = line.userData._origColorHex || line.userData.baseColorHex;
      if (backHex) line.material.color.set(backHex);
      if (line.userData._origOpacity != null) line.material.opacity = line.userData._origOpacity;
      line.material.needsUpdate = true;
      line.userData._hlTimeout = null;
      this.requestRender();
    }, 220);
  }

  getCycleInfo(r){
    const N=r.N, M=r.M;
    if (!Number.isInteger(N) || !Number.isInteger(M) || N<3 || M<1){
      return { valid:false, edges:0, step:0, d:0, L:0, startN:0 };
    }
    const step = MathUtil.mod(M, N);
    const startN = MathUtil.mod(r.start, N);
    const d = MathUtil.gcd(N, step);
    const L = (step===0) ? 0 : (N/d);
    const cyc = CycleBuilder.buildCycle3D(N, M, r.start);
    return { valid:cyc.valid, edges:cyc.edges, step, d, L, startN };
  }

  anyAnimationPlaying(){
    return this.rows.some(r => r.animPlaying);
  }

  _tick(t){
    if (this.lastT == null) this.lastT = t;
    const dt = (t - this.lastT) / 1000;
    this.lastT = t;

    for (const r of this.rows){
      if (!r.animPlaying) continue;

      const info = this.getCycleInfo(r);
      if (!info.valid || info.edges <= 0){
        r.animPlaying = false;
        continue;
      }

      r.animProgressEdges += r.animSpeedEdgesPerSec * dt;

      if (r.animProgressEdges >= info.edges){
        r.animProgressEdges = info.edges;
        r.animPlaying = false;

        const card = this.rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
        if (card && card._setAnimIcon) card._setAnimIcon();
      }

      this.rowBuilder.setRowLineProgress(r, r.animProgressEdges);
    }

    this.updateGlobalInfo();
    this.requestRender();

    if (this.anyAnimationPlaying()){
      this.rafAnim = requestAnimationFrame((tt)=>this._tick(tt));
    } else {
      this.rafAnim = null;
      this.lastT = null;
      if (this.globalPlaying){
        this.globalPlaying = false;
        this.btnToggleAll.textContent = "‚ñ∂ ÂÖ®„Ç¢„Éã„É°ÂÜçÁîü";
      }
    }
  }

  updateGlobalInfo(){
    const total = this.rows.length;
    const playing = this.rows.filter(r => r.animPlaying).length;
    this.globalInfoEl.innerHTML = `
      <b>Ë°®Á§∫</b>: ${total} / <b>„Ç¢„Éã„É°</b>: ${playing}<br/>
      <b>R</b>: ${this.globalState.radius.toFixed(1)} , <b>H</b>: ${this.globalState.height.toFixed(1)}
    `;
  }

  newRowDefaults(){
    const idx = this.rows.length;
    const base = this.palette[idx % this.palette.length];
    return new RowModel({
      id: this.nextId++,
      N: null,
      M: null,
      start: this.DEFAULT_START,
      animTimeSec: this.DEFAULT_ANIM_TIME,
      visible: true,
      showPoints: true,
      showLabels: false,
      labelSizePx: this.DEFAULT_LABEL_SIZE,
      lineColor: base,
      pointColor: base,
    });
  }

  createRowUI(r){
    const app = this;

    const card = document.createElement('div');
    card.className = 'rowCard';
    card.dataset.rowId = String(r.id);

    const fieldN = document.createElement('div');
    fieldN.className = 'field';
    fieldN.innerHTML = `<div class="label">N</div>`;
    const inN = document.createElement('input');
    inN.type = 'number';
    inN.min = '1';
    inN.step = '1';
    inN.placeholder = 'ÔºàÊú™ÂÖ•ÂäõÔºâ';
    inN.value = (r.N == null ? '' : String(r.N));
    fieldN.appendChild(inN);

    const fieldM = document.createElement('div');
    fieldM.className = 'field';
    fieldM.innerHTML = `<div class="label">M</div>`;
    const inM = document.createElement('input');
    inM.type = 'number';
    inM.min = '1';
    inM.step = '1';
    inM.placeholder = 'ÔºàÊú™ÂÖ•ÂäõÔºâ';
    inM.value = (r.M == null ? '' : String(r.M));
    fieldM.appendChild(inM);

    const btnAnim = document.createElement('button');
    btnAnim.className = 'iconBtn';
    btnAnim.title = '„Åì„ÅÆË°å„ÅÆ„Ç¢„Éã„É° ÂÜçÁîü/ÂÅúÊ≠¢';
    btnAnim.textContent = '‚ñ∂';

    const btnGear = document.createElement('button');
    btnGear.className = 'iconBtn';
    btnGear.title = 'Ë®≠ÂÆö';
    btnGear.textContent = '‚öô';

    const btnDel = document.createElement('button');
    btnDel.className = 'iconBtn';
    btnDel.title = 'ÂâäÈô§';
    btnDel.textContent = 'üóë';

    const meta = document.createElement('div');
    meta.className = 'rowMeta';

    const updateMeta = ()=>{
      const N=r.N, M=r.M;
      if (!Number.isInteger(N) || !Number.isInteger(M)){
        meta.textContent = ``;
        return;
      }
      if (N < 2){ meta.textContent = `N „ÅØ 2 ‰ª•‰∏ä`; return; }
      if (M < 1){ meta.textContent = `M „ÅØ 1 ‰ª•‰∏ä`; return; }
      const info = app.getCycleInfo(r);
      const sw = `<span class="swatch" style="background:${r.lineColor}"></span>`;
      meta.innerHTML = `start=${info.startN}, step=${info.step}, edges=${info.edges}, time=${r.animTimeSec.toFixed(1)}s ${sw}`;
    };

    const resetAnim = ()=>{
      r.animPlaying = false;
      r.animProgressEdges = 0.0;
      card._setAnimIcon();
    };

    const stopGlobalIfNeeded = ()=>{
      if (app.globalPlaying){
        app.globalPlaying = false;
        app.btnToggleAll.textContent = "‚ñ∂ ÂÖ®„Ç¢„Éã„É°ÂÜçÁîü";
      }
    };

    const applyN = ()=>{
      const raw = inN.value.trim();
      if (raw === ''){
        r.N = null;
        resetAnim(); stopGlobalIfNeeded();
        card._updateMeta();
        app.hidePickedNM();
        app.redrawAll();
        return;
      }
      const v = Math.floor(Number(raw));
      r.N = Number.isFinite(v) ? Math.max(1, v) : null;
      inN.value = (r.N == null ? '' : String(r.N));
      resetAnim(); stopGlobalIfNeeded();
      card._updateMeta();
      app.hidePickedNM();
      app.redrawAll();
    };

    const applyM = ()=>{
      const raw = inM.value.trim();
      if (raw === ''){
        r.M = null;
        resetAnim(); stopGlobalIfNeeded();
        card._updateMeta();
        app.hidePickedNM();
        app.redrawAll();
        return;
      }
      const v = Math.floor(Number(raw));
      r.M = Number.isFinite(v) ? Math.max(1, v) : null;
      inM.value = (r.M == null ? '' : String(r.M));
      resetAnim(); stopGlobalIfNeeded();
      card._updateMeta();
      app.hidePickedNM();
      app.redrawAll();
    };

    inN.addEventListener('input', applyN);
    inM.addEventListener('input', applyM);
    inN.addEventListener('change', applyN);
    inM.addEventListener('change', applyM);

    btnAnim.addEventListener('click', ()=>{
      const info = app.getCycleInfo(r);
      const edges = info.edges;

      if (!info.valid || edges <= 0){
        r.animPlaying = false;
        r.animProgressEdges = 0.0;
        card._setAnimIcon();
        app.redrawAll();
        return;
      }

      const T = Math.max(0.2, Number(r.animTimeSec) || app.DEFAULT_ANIM_TIME);
      r.animSpeedEdgesPerSec = edges / T;

      r.animPlaying = !r.animPlaying;
      if (r.animPlaying) r.animProgressEdges = 0.0;
      card._setAnimIcon();

      stopGlobalIfNeeded();
      app.hidePickedNM();
      app.redrawAll();
    });

    btnGear.addEventListener('click', ()=> app.openRowSettings(r, card));

    btnDel.addEventListener('click', ()=>{
      stopGlobalIfNeeded();
      app.hidePickedNM();
      const i = app.rows.findIndex(x => x.id === r.id);
      if (i >= 0){
        app.rowBuilder.clearRow3D(app.rows[i]);
        app.rows.splice(i,1);
      }
      card.remove();
      app.redrawAll();
    });

    card._updateMeta = updateMeta;
    card._setAnimIcon = ()=> { btnAnim.textContent = r.animPlaying ? '‚è∏' : '‚ñ∂'; };

    card.appendChild(fieldN);
    card.appendChild(fieldM);
    card.appendChild(btnAnim);
    card.appendChild(btnGear);
    card.appendChild(btnDel);
    card.appendChild(meta);

    updateMeta();
    card._setAnimIcon();
    return card;
  }

  addRow(initial){
    const r = Object.assign(this.newRowDefaults(), initial || {});
    const idx = this.rows.length;
    const base = this.palette[idx % this.palette.length];
    if (!initial || !initial.lineColor) r.lineColor = base;
    if (!initial || !initial.pointColor) r.pointColor = base;

    const t = Number(r.animTimeSec);
    r.animTimeSec = (Number.isFinite(t) && t >= 0.2) ? t : this.DEFAULT_ANIM_TIME;

    const ls = Math.floor(Number(r.labelSizePx));
    r.labelSizePx = (Number.isFinite(ls) && ls >= 8) ? ls : this.DEFAULT_LABEL_SIZE;

    this.rows.push(r);
    this.rowsEl.appendChild(this.createRowUI(r));
    this.redrawAll();
  }

  openRowSettings(r, card){
    this.modalRow = r;
    this.modalRowCard = card;

    this.rowModalTitle.textContent = `Ë®≠ÂÆö #${r.id}`;

    this.optVisible.checked = r.visible;
    this.optShowPoints.checked = r.showPoints;
    this.optShowLabels.checked = r.showLabels;

    this.optLabelSize.value = String(r.labelSizePx);
    this.optLineColor.value = r.lineColor;
    this.optPointColor.value = r.pointColor;

    this.optAnimTime.value = String(Number(r.animTimeSec).toFixed(1));
    this.optStart.value = String(Number.isFinite(r.start) ? r.start : 0);

    this.rowModalOverlay.style.display = 'flex';
  }

  closeRowSettings(){
    this.rowModalOverlay.style.display = 'none';
    this.modalRow = null;
    this.modalRowCard = null;
  }

  syncRowModalToRow(){
    if (!this.modalRow) return;
    const r = this.modalRow;

    r.visible = this.optVisible.checked;
    r.showPoints = this.optShowPoints.checked;
    r.showLabels = this.optShowLabels.checked;

    {
      const v = Math.floor(Number(this.optLabelSize.value));
      r.labelSizePx = (Number.isFinite(v) && v >= 8) ? v : this.DEFAULT_LABEL_SIZE;
      this.optLabelSize.value = String(r.labelSizePx);
    }

    r.lineColor = this.optLineColor.value;
    r.pointColor = this.optPointColor.value;

    {
      const v = Number(this.optAnimTime.value);
      r.animTimeSec = (Number.isFinite(v) && v >= 0.2) ? v : this.DEFAULT_ANIM_TIME;
      this.optAnimTime.value = String(r.animTimeSec.toFixed(1));
    }

    {
      const v = Math.floor(Number(this.optStart.value));
      r.start = Number.isFinite(v) ? v : 0;
      this.optStart.value = String(r.start);
    }

    r.animPlaying = false;
    r.animProgressEdges = 0.0;

    if (this.globalPlaying){
      this.globalPlaying = false;
      this.btnToggleAll.textContent = "‚ñ∂ ÂÖ®„Ç¢„Éã„É°ÂÜçÁîü";
    }

    if (this.modalRowCard && this.modalRowCard._updateMeta) this.modalRowCard._updateMeta();
    if (this.modalRowCard && this.modalRowCard._setAnimIcon) this.modalRowCard._setAnimIcon();

    this.hidePickedNM();
    this.redrawAll();
  }

  openGlobalSettings(){
    this.optCircleColor.value = this.themeManager.state.circleHex;
    this.optTheme.value = this.themeManager.state.theme;
    this.optRadius.value = String(this.globalState.radius.toFixed(1));
    this.optHeight.value = String(this.globalState.height.toFixed(1));
    this.globalModalOverlay.style.display = 'flex';
  }

  closeGlobalSettings(){
    this.globalModalOverlay.style.display = 'none';
  }

  syncGlobalModalToState(){
    this.themeManager.state.theme = this.optTheme.value;
    this.themeManager.state.circleHex = this.optCircleColor.value;

    const r = Number(this.optRadius.value);
    this.globalState.radius = (Number.isFinite(r) && r >= 0.1) ? r : 3.0;

    const h = Number(this.optHeight.value);
    this.globalState.height = (Number.isFinite(h) && h >= 0.1) ? h : 4.0;

    if (this.globalPlaying){
      this.globalPlaying = false;
      this.btnToggleAll.textContent = "‚ñ∂ ÂÖ®„Ç¢„Éã„É°ÂÜçÁîü";
    }

    this.themeManager.applyTheme();
    this.three.rebuildGuides(this.globalState);
    this.hidePickedNM();
    this.redrawAll();
  }

  prepareSpeedsForAll(){
    const validRows = this.rows.filter(r=>{
      const info = this.getCycleInfo(r);
      return info.valid && info.edges > 0;
    });
    const times = validRows.map(r => Math.max(0.2, Number(r.animTimeSec) || this.DEFAULT_ANIM_TIME));
    const Tglobal = times.length ? Math.max(...times) : this.DEFAULT_ANIM_TIME;

    for (const r of this.rows){
      const info = this.getCycleInfo(r);
      r.animProgressEdges = 0.0;
      r.animSpeedEdgesPerSec = (info.valid && info.edges > 0) ? (info.edges / Tglobal) : 0.0;
    }
  }

  resetAll(){
    this.globalPlaying = false;
    this.btnToggleAll.textContent = "‚ñ∂ ÂÖ®„Ç¢„Éã„É°ÂÜçÁîü";
    this.hidePickedNM();

    if (this.rafAnim){
      cancelAnimationFrame(this.rafAnim);
      this.rafAnim = null;
      this.lastT = null;
    }

    for (const r of this.rows) this.rowBuilder.clearRow3D(r);
    this.rows.splice(0, this.rows.length);
    this.rowsEl.innerHTML = '';
    this.nextId = 1;

    this.globalState.radius = 3.0;
    this.globalState.height = 4.0;
    this.themeManager.state.theme = 'dark';
    this.themeManager.state.circleHex = '#b0b0b0';

    this.themeManager.applyTheme();
    this.three.rebuildGuides(this.globalState);

    this.addRow({ N:null, M:null, start:this.DEFAULT_START, animTimeSec:this.DEFAULT_ANIM_TIME, labelSizePx: this.DEFAULT_LABEL_SIZE });
    this.hidePickedNM();
    this.redrawAll();
  }

  _installEvents(){
    this.rowModalClose.addEventListener('click', ()=> this.closeRowSettings());
    this.rowModalOverlay.addEventListener('click', (e)=>{ if (e.target === this.rowModalOverlay) this.closeRowSettings(); });

    [
      this.optVisible, this.optShowPoints, this.optShowLabels, this.optLabelSize,
      this.optLineColor, this.optPointColor, this.optAnimTime, this.optStart
    ].forEach(el=>{
      el.addEventListener('input', ()=> this.syncRowModalToRow());
      el.addEventListener('change', ()=> this.syncRowModalToRow());
    });

    this.globalModalClose.addEventListener('click', ()=> this.closeGlobalSettings());
    this.globalModalOverlay.addEventListener('click', (e)=>{ if (e.target === this.globalModalOverlay) this.closeGlobalSettings(); });

    this.optTheme.addEventListener('change', ()=> this.syncGlobalModalToState());
    this.optCircleColor.addEventListener('input', ()=> this.syncGlobalModalToState());
    this.optRadius.addEventListener('input', ()=> this.syncGlobalModalToState());
    this.optHeight.addEventListener('input', ()=> this.syncGlobalModalToState());

    this.btnAdd.addEventListener('click', ()=> this.addRow());
    this.btnOpenGlobal.addEventListener('click', ()=> this.openGlobalSettings());
    this.btnReset.addEventListener('click', ()=> this.resetAll());

    this.btnToggleAll.addEventListener("click", ()=>{
      this.globalPlaying = !this.globalPlaying;

      if (this.globalPlaying){
        this.prepareSpeedsForAll();

        for (const r of this.rows){
          const info = this.getCycleInfo(r);
          r.animPlaying = info.valid && info.edges > 0;
          r.animProgressEdges = 0.0;

          const card = this.rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
          if (card && card._setAnimIcon) card._setAnimIcon();
        }

        this.btnToggleAll.textContent = "‚è∏ ÂÖ®„Ç¢„Éã„É°ÂÅúÊ≠¢";
        this.hidePickedNM();
        this.redrawAll();
      } else {
        for (const r of this.rows){
          r.animPlaying = false;
          const card = this.rowsEl.querySelector(`.rowCard[data-row-id="${r.id}"]`);
          if (card && card._setAnimIcon) card._setAnimIcon();
        }
        this.btnToggleAll.textContent = "‚ñ∂ ÂÖ®„Ç¢„Éã„É°ÂÜçÁîü";
        this.redrawAll();
      }
    });

    this.btnSave.addEventListener('click', ()=>{
      for (const r of this.rows){
        const info = this.getCycleInfo(r);
        if (info.valid && info.edges > 0){
          this.rowBuilder.setRowLineProgress(r, info.edges);
        }
      }
      this.requestRender();

      const url = this.three.renderer.domElement.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = '3d-string-art.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    window.addEventListener('resize', ()=> this.redrawAll());

    // „ÇØ„É™„ÉÉ„ÇØÂà§ÂÆöÔºà„Éâ„É©„ÉÉ„Ç∞Èô§Â§ñÔºâ
    this.stage.addEventListener('pointerdown', (e)=>{
      this._downX = e.clientX;
      this._downY = e.clientY;
    });

    this.stage.addEventListener('click', (e)=>{
      if (e.button !== 0) return;

      const dx = e.clientX - this._downX;
      const dy = e.clientY - this._downY;
      if ((dx*dx + dy*dy) > 9) return;

      const lineObjects = this.rows.map(r=>r.pathLine).filter(Boolean);
      const hitLine = this.three.pickLine(e.clientX, e.clientY, lineObjects);

      if (!hitLine){
        this.hidePickedNM();
        return;
      }

      const rowId = hitLine.userData.rowId;
      const row = this.rows.find(r=>r.id===rowId);

      if (!row || !Number.isInteger(row.N) || !Number.isInteger(row.M)){
        this.hidePickedNM();
        return;
      }

      this.showPickedNM(row.id, row.N, row.M);
      this.flashHighlightLine(hitLine);
    });

    // „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÁîªËßí„É™„Çª„ÉÉ„Éà
    this.stage.addEventListener('dblclick', (e)=>{
      e.preventDefault();
      this.hidePickedNM();
      this.three.resetViewToFit(this.globalState.radius, this.globalState.height);
      this.requestRender();
    });
  }
}
</script>
</body>
</html>
